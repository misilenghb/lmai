"use client";

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { useLanguage } from '@/contexts/LanguageContext';
import EnergyCharts from './EnergyCharts';
import { useState, useEffect, useMemo } from 'react';
import {
  Target,
  TrendingUp,
  Lightbulb,
  Brain,
  Heart,
  Star,
  Clock,
  CheckCircle,
  ChevronDown,
  ChevronUp,
  Gem,
  Sparkles,
  Zap,
  Calendar,
  Award,
  Activity,
  BarChart3,
  Compass,
  Layers,
  Radar,
  Atom,
  Orbit,
  Hexagon,
  Triangle,
  Waves,
  Gauge,
  LineChart,
  PieChart,
  TrendingDown,
  AlertCircle,
  Shield,
  Flame,
  Snowflake,
  Sun,
  Moon,
  Wind,
  Mountain,
  Users,
  AlertTriangle
} from 'lucide-react';
import type { UserProfileDataOutput } from '@/ai/schemas/user-profile-schemas';

interface ImprovedPersonalizedSuggestionsProps {
  userProfile: UserProfileDataOutput;
  fiveDimensionalData?: Array<{dimension: string, energy: number}>;
  className?: string;
}

// 3Dèƒ½é‡æ¨¡å‹æ•°æ®ç»“æ„
interface EnergyModel3D {
  physical: number;    // èº«ä½“èƒ½é‡ (0-100)
  mental: number;      // å¿ƒç†èƒ½é‡ (0-100)
  spiritual: number;   // ç²¾ç¥èƒ½é‡ (0-100)
  balance: number;     // å¹³è¡¡æŒ‡æ•° (0-100)
  trend: 'rising' | 'stable' | 'declining';
  recommendations: string[];
}

// ç§‘å­¦åŒ–å»ºè®®ç±»å‹
interface ScientificSuggestion {
  id: string;
  title: string;
  description: string;
  scientificBasis: string;
  evidenceLevel: 'high' | 'medium' | 'low';
  timeCommitment: string;
  difficulty: 'easy' | 'medium' | 'hard';
  category: 'energy' | 'wellness' | 'productivity' | 'relationships' | 'growth';
  icon: string;
  crystalConnection?: string;
  researchCitation?: string;
  expectedOutcome: string;
  measurementMethod: string;
}

// æ¯æ—¥èƒ½é‡é¢„æµ‹
interface DailyEnergyForecast {
  date: string;
  energyPeak: string;    // èƒ½é‡é«˜å³°æ—¶é—´
  energyLow: string;     // èƒ½é‡ä½è°·æ—¶é—´
  optimalActivities: string[];
  avoidActivities: string[];
  crystalRecommendation: string;
  biorhythmPhase: 'physical' | 'emotional' | 'intellectual';
}



// è®¡ç®—3Dèƒ½é‡æ¨¡å‹ - ç®€åŒ–ç‰ˆæœ¬é¿å…å¤æ‚è®¡ç®—
const calculate3DEnergyModel = (userProfile: UserProfileDataOutput, fiveDimensionalData?: Array<{dimension: string, energy: number}>): EnergyModel3D => {
  try {
    const currentHour = new Date().getHours();
    const currentDay = new Date().getDay();

  // åŸºäºç”Ÿç‰©èŠ‚å¾‹è®¡ç®—èº«ä½“èƒ½é‡
  const calculatePhysicalEnergy = (): number => {
    // åŸºäºæ˜¼å¤œèŠ‚å¾‹ç†è®º (Circadian Rhythm Theory)
    let baseEnergy = 70;

    // æ˜¼å¤œèŠ‚å¾‹å½±å“ (Roenneberg et al., 2007)
    if (currentHour >= 6 && currentHour <= 10) baseEnergy += 15; // æ™¨é—´é«˜å³°
    else if (currentHour >= 14 && currentHour <= 16) baseEnergy += 10; // ä¸‹åˆå°é«˜å³°
    else if (currentHour >= 22 || currentHour <= 5) baseEnergy -= 20; // å¤œé—´ä½è°·

    // MBTIç±»å‹å½±å“
    if (userProfile.mbtiLikeType?.includes('E')) baseEnergy += 5; // å¤–å‘è€…èƒ½é‡æ›´å……æ²›
    if (userProfile.mbtiLikeType?.includes('S')) baseEnergy += 3; // å®æ„Ÿè€…èº«ä½“æ„ŸçŸ¥æ›´æ•é”

    return Math.min(100, Math.max(0, baseEnergy));
  };

  // åŸºäºè®¤çŸ¥è´Ÿè·ç†è®ºè®¡ç®—å¿ƒç†èƒ½é‡
  const calculateMentalEnergy = (): number => {
    let baseEnergy = 75;

    // è®¤çŸ¥è´Ÿè·ç†è®º (Sweller, 1988)
    if (currentHour >= 9 && currentHour <= 11) baseEnergy += 15; // è®¤çŸ¥é«˜å³°æœŸ
    else if (currentHour >= 13 && currentHour <= 15) baseEnergy -= 10; // åˆåä½è°·

    // MBTIè®¤çŸ¥åŠŸèƒ½å½±å“
    if (userProfile.mbtiLikeType?.includes('N')) baseEnergy += 8; // ç›´è§‰è€…æ€ç»´æ›´æ´»è·ƒ
    if (userProfile.mbtiLikeType?.includes('T')) baseEnergy += 5; // æ€ç»´è€…é€»è¾‘å¤„ç†èƒ½åŠ›å¼º

    // äº”ç»´æ•°æ®å½±å“
    if (fiveDimensionalData) {
      const mentalDimensions = fiveDimensionalData.filter(d =>
        d.dimension.includes('æ™ºåŠ›') || d.dimension.includes('æ€ç»´') || d.dimension.includes('Mental')
      );
      if (mentalDimensions.length > 0) {
        const avgMental = mentalDimensions.reduce((sum, d) => sum + d.energy, 0) / mentalDimensions.length;
        baseEnergy = (baseEnergy + avgMental) / 2;
      }
    }

    return Math.min(100, Math.max(0, baseEnergy));
  };

  // åŸºäºé©¬æ–¯æ´›éœ€æ±‚å±‚æ¬¡ç†è®ºè®¡ç®—ç²¾ç¥èƒ½é‡
  const calculateSpiritualEnergy = (): number => {
    let baseEnergy = 65;

    // é©¬æ–¯æ´›è‡ªæˆ‘å®ç°ç†è®º (Maslow, 1943)
    if (userProfile.mbtiLikeType?.includes('F')) baseEnergy += 10; // æƒ…æ„Ÿè€…ç²¾ç¥éœ€æ±‚æ›´å¼º
    if (userProfile.mbtiLikeType?.includes('P')) baseEnergy += 5; // æ„ŸçŸ¥è€…æ›´å¼€æ”¾

    // æ˜Ÿåº§å½±å“ (åŸºäºå¿ƒç†å­¦ç ”ç©¶)
    const spiritualSigns = ['åŒé±¼åº§', 'Pisces', 'å¤©èåº§', 'Scorpio', 'å·¨èŸ¹åº§', 'Cancer'];
    if (userProfile.inferredZodiac && spiritualSigns.includes(userProfile.inferredZodiac)) {
      baseEnergy += 8;
    }

    // å‘¨æœ«ç²¾ç¥èƒ½é‡æå‡
    if (currentDay === 0 || currentDay === 6) baseEnergy += 10;

    return Math.min(100, Math.max(0, baseEnergy));
  };

  const physical = calculatePhysicalEnergy();
  const mental = calculateMentalEnergy();
  const spiritual = calculateSpiritualEnergy();

  // è®¡ç®—å¹³è¡¡æŒ‡æ•° (åŸºäºæ–¹å·®åˆ†æ)
  const mean = (physical + mental + spiritual) / 3;
  const variance = ((physical - mean) ** 2 + (mental - mean) ** 2 + (spiritual - mean) ** 2) / 3;
  const balance = Math.max(0, 100 - Math.sqrt(variance) * 2);

  // è¶‹åŠ¿åˆ†æ (åŸºäºå½“å‰æ—¶é—´å’Œå†å²æ¨¡å¼)
  let trend: 'rising' | 'stable' | 'declining' = 'stable';
  if (currentHour >= 6 && currentHour <= 12) trend = 'rising';
  else if (currentHour >= 18 && currentHour <= 23) trend = 'declining';

    return {
      physical,
      mental,
      spiritual,
      balance,
      trend,
      recommendations: generateEnergyRecommendations(physical, mental, spiritual, balance)
    };
  } catch (error) {
    console.error('Error in calculate3DEnergyModel:', error);
    // è¿”å›å®‰å…¨çš„é»˜è®¤å€¼
    return {
      physical: 70,
      mental: 70,
      spiritual: 70,
      balance: 70,
      trend: 'stable' as const,
      recommendations: ['è¯·ç¨åé‡è¯•']
    };
  }
};

// ç”Ÿæˆèƒ½é‡ä¼˜åŒ–å»ºè®®
const generateEnergyRecommendations = (physical: number, mental: number, spiritual: number, balance: number): string[] => {
  const recommendations: string[] = [];

  if (physical < 60) {
    recommendations.push("å¢åŠ æœ‰æ°§è¿åŠ¨ï¼Œæå‡èº«ä½“èƒ½é‡");
    recommendations.push("ç¡®ä¿å……è¶³ç¡çœ ï¼Œéµå¾ªæ˜¼å¤œèŠ‚å¾‹");
  }

  if (mental < 60) {
    recommendations.push("è¿›è¡Œè®¤çŸ¥è®­ç»ƒï¼Œå¦‚å†¥æƒ³æˆ–æ­£å¿µç»ƒä¹ ");
    recommendations.push("å‡å°‘å¤šä»»åŠ¡å¤„ç†ï¼Œä¸“æ³¨å•ä¸€ä»»åŠ¡");
  }

  if (spiritual < 60) {
    recommendations.push("åŸ¹å…»æ„Ÿæ©ä¹ æƒ¯ï¼Œæå‡ç²¾ç¥æ»¡è¶³æ„Ÿ");
    recommendations.push("å‚ä¸æœ‰æ„ä¹‰çš„æ´»åŠ¨æˆ–å¿—æ„¿æœåŠ¡");
  }

  if (balance < 70) {
    recommendations.push("å¹³è¡¡å„ç»´åº¦å‘å±•ï¼Œé¿å…è¿‡åº¦åé‡");
    recommendations.push("å»ºç«‹è§„å¾‹çš„ä½œæ¯å’Œæ´»åŠ¨å®‰æ’");
  }

  return recommendations;
};

// ç”Ÿæˆç§‘å­¦åŒ–çš„ä¸ªæ€§åŒ–å»ºè®® - ç®€åŒ–ç‰ˆæœ¬
const generateScientificSuggestions = (userProfile: UserProfileDataOutput, energyModel: EnergyModel3D, language: string): ScientificSuggestion[] => {
  try {
    const suggestions: ScientificSuggestion[] = [];
    const mbtiType = userProfile.mbtiLikeType || '';

  // åŸºäº3Dèƒ½é‡æ¨¡å‹çš„å»ºè®®
  if (energyModel.physical < 70) {
    suggestions.push({
      id: 'physical-boost',
      title: language === 'zh' ? 'ğŸƒâ€â™‚ï¸ ç”Ÿç‰©èŠ‚å¾‹ä¼˜åŒ–è¿åŠ¨' : 'ğŸƒâ€â™‚ï¸ Circadian Rhythm Exercise',
      description: language === 'zh' ?
        'æ ¹æ®æ‚¨å½“å‰çš„èº«ä½“èƒ½é‡æ°´å¹³ï¼Œå»ºè®®è¿›è¡Œ15åˆ†é’Ÿä¸­ç­‰å¼ºåº¦æœ‰æ°§è¿åŠ¨ï¼Œé…åˆçº¢ç¢§çºå¢å¼ºæ´»åŠ›' :
        'Based on your current physical energy level, 15 minutes of moderate aerobic exercise with red tourmaline is recommended',
      scientificBasis: language === 'zh' ?
        'åŸºäºæ˜¼å¤œèŠ‚å¾‹ç†è®ºå’Œè¿åŠ¨ç”Ÿç†å­¦ï¼Œæœ‰æ°§è¿åŠ¨å¯æå‡çº¿ç²’ä½“åŠŸèƒ½å’ŒATPäº§ç”Ÿæ•ˆç‡' :
        'Based on circadian rhythm theory and exercise physiology, aerobic exercise enhances mitochondrial function and ATP production efficiency',
      evidenceLevel: 'high',
      timeCommitment: '15-20åˆ†é’Ÿ',
      difficulty: 'easy',
      category: 'energy',
      icon: 'ğŸƒâ€â™‚ï¸',
      crystalConnection: language === 'zh' ? 'çº¢ç¢§çºæ¿€å‘èº«ä½“æ´»åŠ›å’Œè¡€æ¶²å¾ªç¯' : 'Red tourmaline stimulates physical vitality and circulation',
      researchCitation: 'Roenneberg, T. et al. (2007). Life between Clocks: Daily Temporal Patterns',
      expectedOutcome: language === 'zh' ? 'æå‡èº«ä½“èƒ½é‡15-25%ï¼Œæ”¹å–„è¡€æ¶²å¾ªç¯' : 'Increase physical energy by 15-25%, improve circulation',
      measurementMethod: language === 'zh' ? 'é€šè¿‡å¿ƒç‡å˜å¼‚æ€§å’Œä¸»è§‚èƒ½é‡è¯„åˆ†æµ‹é‡' : 'Measured through heart rate variability and subjective energy scores'
    });
  }

  if (energyModel.mental < 70) {
    suggestions.push({
      id: 'cognitive-enhancement',
      title: language === 'zh' ? 'ğŸ§  è®¤çŸ¥è´Ÿè·ç®¡ç†å†¥æƒ³' : 'ğŸ§  Cognitive Load Management Meditation',
      description: language === 'zh' ?
        'é‡‡ç”¨æ­£å¿µå†¥æƒ³æŠ€æœ¯ï¼Œé…åˆç´«æ°´æ™¶ï¼Œä¼˜åŒ–å¤§è„‘è®¤çŸ¥èµ„æºåˆ†é…ï¼Œæå‡ä¸“æ³¨åŠ›' :
        'Use mindfulness meditation with amethyst to optimize brain cognitive resource allocation and enhance focus',
      scientificBasis: language === 'zh' ?
        'åŸºäºè®¤çŸ¥è´Ÿè·ç†è®ºå’Œç¥ç»å¯å¡‘æ€§ç ”ç©¶ï¼Œæ­£å¿µç»ƒä¹ å¯é‡å¡‘å¤§è„‘ç¥ç»ç½‘ç»œ' :
        'Based on cognitive load theory and neuroplasticity research, mindfulness practice can reshape brain neural networks',
      evidenceLevel: 'high',
      timeCommitment: '10-15åˆ†é’Ÿ',
      difficulty: 'medium',
      category: 'wellness',
      icon: 'ğŸ§ ',
      crystalConnection: language === 'zh' ? 'ç´«æ°´æ™¶å¢å¼ºå¤§è„‘Î±æ³¢æ´»åŠ¨ï¼Œä¿ƒè¿›ä¸“æ³¨' : 'Amethyst enhances brain alpha wave activity, promoting focus',
      researchCitation: 'Sweller, J. (1988). Cognitive Load Theory and Educational Technology',
      expectedOutcome: language === 'zh' ? 'æå‡è®¤çŸ¥æ•ˆç‡20-30%ï¼Œå‡å°‘å¿ƒç†ç–²åŠ³' : 'Improve cognitive efficiency by 20-30%, reduce mental fatigue',
      measurementMethod: language === 'zh' ? 'é€šè¿‡æ³¨æ„åŠ›æµ‹è¯•å’Œè„‘ç”µå›¾ç›‘æµ‹' : 'Measured through attention tests and EEG monitoring'
    });
  }

  if (energyModel.spiritual < 70) {
    suggestions.push({
      id: 'spiritual-alignment',
      title: language === 'zh' ? 'ğŸŒŸ è‡ªæˆ‘å®ç°ä»·å€¼å¯¹é½' : 'ğŸŒŸ Self-Actualization Value Alignment',
      description: language === 'zh' ?
        'åŸºäºé©¬æ–¯æ´›éœ€æ±‚å±‚æ¬¡ç†è®ºï¼Œè¿›è¡Œä»·å€¼è§‚æ¾„æ¸…ç»ƒä¹ ï¼Œé…åˆæœˆå…‰çŸ³è¿æ¥å†…åœ¨æ™ºæ…§' :
        'Based on Maslow\'s hierarchy of needs, practice value clarification with moonstone to connect inner wisdom',
      scientificBasis: language === 'zh' ?
        'é©¬æ–¯æ´›è‡ªæˆ‘å®ç°ç†è®ºè¡¨æ˜ï¼Œä»·å€¼å¯¹é½æ˜¯ç²¾ç¥æ»¡è¶³çš„å…³é”®å› ç´ ' :
        'Maslow\'s self-actualization theory shows that value alignment is key to spiritual fulfillment',
      evidenceLevel: 'medium',
      timeCommitment: '20-30åˆ†é’Ÿ',
      difficulty: 'medium',
      category: 'growth',
      icon: 'ğŸŒŸ',
      crystalConnection: language === 'zh' ? 'æœˆå…‰çŸ³æ¿€å‘ç›´è§‰å’Œå†…åœ¨æ™ºæ…§' : 'Moonstone stimulates intuition and inner wisdom',
      researchCitation: 'Maslow, A. H. (1943). A Theory of Human Motivation',
      expectedOutcome: language === 'zh' ? 'æå‡ç”Ÿæ´»æ„ä¹‰æ„Ÿå’Œç²¾ç¥æ»¡è¶³åº¦' : 'Enhance sense of life meaning and spiritual satisfaction',
      measurementMethod: language === 'zh' ? 'é€šè¿‡ç”Ÿæ´»æ»¡æ„åº¦é‡è¡¨å’Œä»·å€¼è§‚è¯„ä¼°' : 'Measured through life satisfaction scales and value assessments'
    });
  }

  // åŸºäºMBTIç±»å‹çš„ä¸ªæ€§åŒ–å»ºè®®
  if (mbtiType.includes('I')) {
    suggestions.push({
      id: 'introvert-recharge',
      title: language === 'zh' ? 'ğŸ”‹ å†…å‘è€…èƒ½é‡å……ç”µæ³•' : 'ğŸ”‹ Introvert Energy Recharge Method',
      description: language === 'zh' ?
        'åˆ›å»ºä¸ªäººèƒ½é‡åº‡æŠ¤æ‰€ï¼Œä½¿ç”¨æ‹‰é•¿çŸ³è¿›è¡Œæ·±åº¦å†…çœï¼Œæ¢å¤ç¤¾äº¤æ¶ˆè€—çš„èƒ½é‡' :
        'Create a personal energy sanctuary, use labradorite for deep introspection to restore socially depleted energy',
      scientificBasis: language === 'zh' ?
        'åŸºäºè‰¾æ£®å…‹äººæ ¼ç†è®ºï¼Œå†…å‘è€…é€šè¿‡ç‹¬å¤„æ¿€æ´»å‰¯äº¤æ„Ÿç¥ç»ç³»ç»Ÿï¼Œæ¢å¤èƒ½é‡' :
        'Based on Eysenck\'s personality theory, introverts activate the parasympathetic nervous system through solitude to restore energy',
      evidenceLevel: 'high',
      timeCommitment: '15-25åˆ†é’Ÿ',
      difficulty: 'easy',
      category: 'energy',
      icon: 'ğŸ”‹',
      crystalConnection: language === 'zh' ? 'æ‹‰é•¿çŸ³å¢å¼ºå†…åœ¨æ´å¯ŸåŠ›å’Œç›´è§‰' : 'Labradorite enhances inner insight and intuition',
      researchCitation: 'Eysenck, H. J. (1967). The Biological Basis of Personality',
      expectedOutcome: language === 'zh' ? 'æ¢å¤ç¤¾äº¤èƒ½é‡ï¼Œæå‡å†…åœ¨å¹³é™æ„Ÿ' : 'Restore social energy, enhance inner tranquility',
      measurementMethod: language === 'zh' ? 'é€šè¿‡èƒ½é‡æ°´å¹³è‡ªè¯„å’Œå‹åŠ›æ¿€ç´ æµ‹é‡' : 'Measured through energy self-assessment and stress hormone levels'
    });
  }

  if (mbtiType.includes('E')) {
    suggestions.push({
      id: 'extrovert-connection',
      title: language === 'zh' ? 'ğŸ¤ å¤–å‘è€…ç¤¾äº¤èƒ½é‡æ¿€æ´»' : 'ğŸ¤ Extrovert Social Energy Activation',
      description: language === 'zh' ?
        'ä¸»åŠ¨å‘èµ·æœ‰æ„ä¹‰çš„ç¤¾äº¤äº’åŠ¨ï¼Œä½©æˆ´é»„æ°´æ™¶å¢å¼ºæ²Ÿé€šé­…åŠ›å’Œè‡ªä¿¡è¡¨è¾¾' :
        'Actively initiate meaningful social interactions, wear citrine to enhance communication charm and confident expression',
      scientificBasis: language === 'zh' ?
        'ç¤¾ä¼šè®¤çŸ¥ç†è®ºè¡¨æ˜ï¼Œå¤–å‘è€…é€šè¿‡ç¤¾äº¤äº’åŠ¨æ¿€æ´»å¥–åŠ±ç³»ç»Ÿï¼Œè·å¾—å¤šå·´èƒºé‡Šæ”¾' :
        'Social cognitive theory shows extroverts activate reward systems through social interaction, gaining dopamine release',
      evidenceLevel: 'high',
      timeCommitment: '20-30åˆ†é’Ÿ',
      difficulty: 'easy',
      category: 'relationships',
      icon: 'ğŸ¤',
      crystalConnection: language === 'zh' ? 'é»„æ°´æ™¶æ¿€å‘è‡ªä¿¡å’Œè¡¨è¾¾èƒ½åŠ›' : 'Citrine stimulates confidence and expression abilities',
      researchCitation: 'Bandura, A. (1991). Social Cognitive Theory of Self-Regulation',
      expectedOutcome: language === 'zh' ? 'æå‡ç¤¾äº¤æ»¡è¶³æ„Ÿå’Œæƒ…ç»ªæ­£å‘æ€§' : 'Enhance social satisfaction and emotional positivity',
      measurementMethod: language === 'zh' ? 'é€šè¿‡ç¤¾äº¤æ»¡æ„åº¦å’Œæƒ…ç»ªçŠ¶æ€è¯„ä¼°' : 'Measured through social satisfaction and emotional state assessment'
    });
  }

    return suggestions;
  } catch (error) {
    console.error('Error in generateScientificSuggestions:', error);
    // è¿”å›åŸºæœ¬å»ºè®®
    return [{
      id: 'basic-suggestion',
      title: language === 'zh' ? 'ğŸ§˜ åŸºç¡€å†¥æƒ³ç»ƒä¹ ' : 'ğŸ§˜ Basic Meditation',
      description: language === 'zh' ? 'è¿›è¡Œ10åˆ†é’Ÿçš„æ·±å‘¼å¸ç»ƒä¹ ï¼Œå¸®åŠ©æ”¾æ¾èº«å¿ƒ' : 'Practice 10 minutes of deep breathing to relax body and mind',
      scientificBasis: language === 'zh' ? 'åŸºäºæ­£å¿µå†¥æƒ³çš„ç§‘å­¦ç ”ç©¶' : 'Based on scientific research on mindfulness meditation',
      evidenceLevel: 'high' as const,
      timeCommitment: '10åˆ†é’Ÿ',
      difficulty: 'easy' as const,
      category: 'wellness' as const,
      icon: 'ğŸ§˜',
      expectedOutcome: language === 'zh' ? 'å‡å°‘å‹åŠ›ï¼Œæå‡ä¸“æ³¨åŠ›' : 'Reduce stress, improve focus',
      measurementMethod: language === 'zh' ? 'ä¸»è§‚æ„Ÿå—è¯„ä¼°' : 'Subjective feeling assessment'
    }];
  }
};

// ç”Ÿæˆæ¯æ—¥èƒ½é‡é¢„æµ‹ - ç®€åŒ–ç‰ˆæœ¬
const generateDailyEnergyForecast = (userProfile: UserProfileDataOutput, language: string): DailyEnergyForecast => {
  try {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const mbtiType = userProfile.mbtiLikeType || '';

  // åŸºäºç”Ÿç‰©èŠ‚å¾‹å’Œä¸ªäººç‰¹è´¨é¢„æµ‹èƒ½é‡æ¨¡å¼
  let energyPeak = '09:00-11:00';
  let energyLow = '14:00-16:00';

  // MBTIç±»å‹å½±å“èƒ½é‡æ¨¡å¼
  if (mbtiType.includes('E')) {
    energyPeak = '10:00-12:00'; // å¤–å‘è€…ç¨æ™šè¾¾åˆ°é«˜å³°
    energyLow = '13:00-15:00';
  } else {
    energyPeak = '08:00-10:00'; // å†…å‘è€…æ›´æ—©è¾¾åˆ°é«˜å³°
    energyLow = '15:00-17:00';
  }

  // å‘¨æœ«è°ƒæ•´
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    energyPeak = '10:00-12:00'; // å‘¨æœ«ç¨æ™šèµ·
    energyLow = '16:00-18:00';
  }

  // åŸºäºèƒ½é‡é«˜å³°æ¨èæ´»åŠ¨
  const getOptimalActivities = (): string[] => {
    const activities = [];

    if (mbtiType.includes('T')) {
      activities.push(language === 'zh' ? 'é€»è¾‘åˆ†æä»»åŠ¡' : 'Logical analysis tasks');
      activities.push(language === 'zh' ? 'æ•°æ®å¤„ç†å·¥ä½œ' : 'Data processing work');
    }

    if (mbtiType.includes('F')) {
      activities.push(language === 'zh' ? 'äººé™…æ²Ÿé€šäº¤æµ' : 'Interpersonal communication');
      activities.push(language === 'zh' ? 'åˆ›æ„è¡¨è¾¾æ´»åŠ¨' : 'Creative expression activities');
    }

    if (mbtiType.includes('N')) {
      activities.push(language === 'zh' ? 'å¤´è„‘é£æš´ä¼šè®®' : 'Brainstorming sessions');
      activities.push(language === 'zh' ? 'æ¦‚å¿µæ€§æ€è€ƒ' : 'Conceptual thinking');
    }

    if (mbtiType.includes('S')) {
      activities.push(language === 'zh' ? 'ç»†èŠ‚å¤„ç†å·¥ä½œ' : 'Detail-oriented work');
      activities.push(language === 'zh' ? 'å®é™…æ“ä½œä»»åŠ¡' : 'Hands-on tasks');
    }

    return activities.slice(0, 3); // è¿”å›å‰3ä¸ª
  };

  // åŸºäºèƒ½é‡ä½è°·æ¨èé¿å…çš„æ´»åŠ¨
  const getAvoidActivities = (): string[] => {
    return [
      language === 'zh' ? 'é‡è¦å†³ç­–åˆ¶å®š' : 'Important decision making',
      language === 'zh' ? 'å¤æ‚é—®é¢˜è§£å†³' : 'Complex problem solving',
      language === 'zh' ? 'é«˜å¼ºåº¦ç¤¾äº¤' : 'High-intensity socializing'
    ];
  };

  // åŸºäºæ˜Ÿåº§æ¨èæ°´æ™¶
  const getCrystalRecommendation = (): string => {
    const zodiac = userProfile.inferredZodiac || '';
    const crystalMap: Record<string, string> = {
      'ç™½ç¾Šåº§': language === 'zh' ? 'çº¢ç¢§çº - æ¿€å‘è¡ŒåŠ¨åŠ›' : 'Red Tourmaline - Stimulate action',
      'Aries': language === 'zh' ? 'çº¢ç¢§çº - æ¿€å‘è¡ŒåŠ¨åŠ›' : 'Red Tourmaline - Stimulate action',
      'é‡‘ç‰›åº§': language === 'zh' ? 'ç»¿å¹½çµ - ç¨³å®šèƒ½é‡' : 'Green Phantom - Stabilize energy',
      'Taurus': language === 'zh' ? 'ç»¿å¹½çµ - ç¨³å®šèƒ½é‡' : 'Green Phantom - Stabilize energy',
      'åŒå­åº§': language === 'zh' ? 'é»„æ°´æ™¶ - å¢å¼ºæ²Ÿé€š' : 'Citrine - Enhance communication',
      'Gemini': language === 'zh' ? 'é»„æ°´æ™¶ - å¢å¼ºæ²Ÿé€š' : 'Citrine - Enhance communication',
      'å·¨èŸ¹åº§': language === 'zh' ? 'æœˆå…‰çŸ³ - æƒ…æ„Ÿå¹³è¡¡' : 'Moonstone - Emotional balance',
      'Cancer': language === 'zh' ? 'æœˆå…‰çŸ³ - æƒ…æ„Ÿå¹³è¡¡' : 'Moonstone - Emotional balance',
      'ç‹®å­åº§': language === 'zh' ? 'å¤ªé˜³çŸ³ - æå‡è‡ªä¿¡' : 'Sunstone - Boost confidence',
      'Leo': language === 'zh' ? 'å¤ªé˜³çŸ³ - æå‡è‡ªä¿¡' : 'Sunstone - Boost confidence',
      'å¤„å¥³åº§': language === 'zh' ? 'ç´«æ°´æ™¶ - å¢å¼ºä¸“æ³¨' : 'Amethyst - Enhance focus',
      'Virgo': language === 'zh' ? 'ç´«æ°´æ™¶ - å¢å¼ºä¸“æ³¨' : 'Amethyst - Enhance focus'
    };

    return crystalMap[zodiac] || (language === 'zh' ? 'ç™½æ°´æ™¶ - å‡€åŒ–èƒ½é‡' : 'Clear Quartz - Purify energy');
  };

  // è®¡ç®—ç”Ÿç‰©èŠ‚å¾‹ç›¸ä½
  const getBiorhythmPhase = (): 'physical' | 'emotional' | 'intellectual' => {
    // ä½¿ç”¨ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤æ—¥æœŸè®¡ç®—ï¼Œé¿å…æ½œåœ¨çš„æ—¥æœŸé”™è¯¯
    const birthDate = new Date('1990-01-01'); // é»˜è®¤æ—¥æœŸ
    const daysSinceBirth = Math.floor((today.getTime() - birthDate.getTime()) / (1000 * 60 * 60 * 24));

    // ç®€åŒ–çš„ç”Ÿç‰©èŠ‚å¾‹è®¡ç®—
    const physicalCycle = Math.sin((2 * Math.PI * daysSinceBirth) / 23);
    const emotionalCycle = Math.sin((2 * Math.PI * daysSinceBirth) / 28);
    const intellectualCycle = Math.sin((2 * Math.PI * daysSinceBirth) / 33);

    const maxCycle = Math.max(physicalCycle, emotionalCycle, intellectualCycle);

    if (maxCycle === physicalCycle) return 'physical';
    if (maxCycle === emotionalCycle) return 'emotional';
    return 'intellectual';
  };

    return {
      date: today.toISOString().split('T')[0],
      energyPeak,
      energyLow,
      optimalActivities: getOptimalActivities(),
      avoidActivities: getAvoidActivities(),
      crystalRecommendation: getCrystalRecommendation(),
      biorhythmPhase: getBiorhythmPhase()
    };
  } catch (error) {
    console.error('Error in generateDailyEnergyForecast:', error);
    // è¿”å›å®‰å…¨çš„é»˜è®¤å€¼
    return {
      date: new Date().toISOString().split('T')[0],
      energyPeak: '09:00-11:00',
      energyLow: '14:00-16:00',
      optimalActivities: [language === 'zh' ? 'è½»æ¾å·¥ä½œ' : 'Light work'],
      avoidActivities: [language === 'zh' ? 'é«˜å¼ºåº¦ä»»åŠ¡' : 'High intensity tasks'],
      crystalRecommendation: language === 'zh' ? 'ç™½æ°´æ™¶ - å‡€åŒ–èƒ½é‡' : 'Clear Quartz - Purify energy',
      biorhythmPhase: 'physical' as const
    };
  }
};

// ä¿ç•™åŸæœ‰å‡½æ•°ä»¥å…¼å®¹æ€§ï¼Œä½†æ ‡è®°ä¸ºå·²å¼ƒç”¨
const generateEnhancedSuggestions = (userProfile: UserProfileDataOutput, language: string) => {
  const suggestions = {
    immediate: [] as Array<{
      title: string;
      description: string;
      timeCommitment: string;
      difficulty: 'easy' | 'medium' | 'hard';
      category: string;
      icon: string;
      crystalConnection?: string;
      tip?: string;
    }>,
    insights: [] as Array<{
      trait: string;
      description: string;
      strength: string;
      application: string;
    }>
  };

  const mbtiType = userProfile.mbtiLikeType || '';
  
  // ç«‹å³è¡ŒåŠ¨å»ºè®®
  if (mbtiType.includes('I')) {
    suggestions.immediate.push({
      title: language === 'zh' ? 'ğŸ§˜ å†…åœ¨èƒ½é‡å……ç”µ' : 'ğŸ§˜ Inner Energy Recharge',
      description: language === 'zh' ? 
        'æ‰¾ä¸€ä¸ªå®‰é™çš„è§’è½ï¼Œç‚¹ç‡ƒä¸€æ”¯é¦™è–°èœ¡çƒ›ï¼Œæ¡ç€ç´«æ°´æ™¶è¿›è¡Œ10åˆ†é’Ÿçš„æ·±åº¦å†¥æƒ³ï¼Œæ„Ÿå—å†…å¿ƒçš„å¹³é™ä¸åŠ›é‡' :
        'Find a quiet corner, light an aromatherapy candle, hold amethyst for 10 minutes of deep meditation, feel inner peace and strength',
      timeCommitment: language === 'zh' ? '10-15åˆ†é’Ÿ' : '10-15 minutes',
      difficulty: 'easy',
      category: language === 'zh' ? 'èƒ½é‡æ¢å¤' : 'Energy Recovery',
      icon: 'ğŸ§˜',
      crystalConnection: language === 'zh' ? 'ç´«æ°´æ™¶å¢å¼ºä¸“æ³¨åŠ›å’Œå†…åœ¨å¹³é™' : 'Amethyst enhances focus and inner peace',
      tip: language === 'zh' ? 'å†…å‘è€…é€šè¿‡ç‹¬å¤„è·å¾—èƒ½é‡ï¼Œè¿™æ˜¯å¤©èµ‹è€Œéç¼ºé™·' : 'Introverts gain energy through solitude - this is a gift, not a flaw'
    });
  } else {
    suggestions.immediate.push({
      title: language === 'zh' ? 'ğŸ’¬ æ´»åŠ›ç¤¾äº¤è¿æ¥' : 'ğŸ’¬ Energizing Social Connection',
      description: language === 'zh' ? 
        'ä¸»åŠ¨è”ç³»ä¸€ä½å¥½å‹ï¼Œåˆ†äº«ä»Šå¤©çš„è§é—»æˆ–è®¡åˆ’ï¼Œä½©æˆ´é»„æ°´æ™¶å¢å¼ºæ²Ÿé€šçš„è‡ªä¿¡å’Œé­…åŠ›' :
        'Actively contact a good friend, share today\'s experiences or plans, wear citrine to enhance communication confidence and charm',
      timeCommitment: language === 'zh' ? '15-20åˆ†é’Ÿ' : '15-20 minutes',
      difficulty: 'easy',
      category: language === 'zh' ? 'ç¤¾äº¤èƒ½é‡' : 'Social Energy',
      icon: 'ğŸ’¬',
      crystalConnection: language === 'zh' ? 'é»„æ°´æ™¶æ¿€å‘è‡ªä¿¡å’Œè¡¨è¾¾èƒ½åŠ›' : 'Citrine stimulates confidence and expression',
      tip: language === 'zh' ? 'å¤–å‘è€…é€šè¿‡çœŸè¯šäº¤æµè·å¾—æ´»åŠ›' : 'Extroverts gain vitality through genuine communication'
    });
  }

  if (mbtiType.includes('N')) {
    suggestions.immediate.push({
      title: language === 'zh' ? 'âœ¨ åˆ›æ„çµæ„Ÿæ•æ‰' : 'âœ¨ Creative Inspiration Capture',
      description: language === 'zh' ? 
        'éšèº«æºå¸¦æœˆå…‰çŸ³ï¼Œå½“æœ‰çµæ„Ÿé—ªç°æ—¶è½»æŠšå®ƒçš„è¡¨é¢ï¼ŒåŒæ—¶ç”¨æ‰‹æœºè®°å½•ä¸‹è¿™äº›çè´µçš„æƒ³æ³•' :
        'Carry moonstone with you, gently touch its surface when inspiration strikes, and record these precious ideas on your phone',
      timeCommitment: language === 'zh' ? 'éšæ—¶è¿›è¡Œ' : 'Anytime',
      difficulty: 'easy',
      category: language === 'zh' ? 'åˆ›æ„æ¿€å‘' : 'Creativity Boost',
      icon: 'âœ¨',
      crystalConnection: language === 'zh' ? 'æœˆå…‰çŸ³æ¿€å‘ç›´è§‰å’Œåˆ›é€ åŠ›' : 'Moonstone stimulates intuition and creativity'
    });
  } else {
    suggestions.immediate.push({
      title: language === 'zh' ? 'ğŸ“‹ å®ç”¨è®¡åˆ’åˆ¶å®š' : 'ğŸ“‹ Practical Planning',
      description: language === 'zh' ? 
        'æ¡ç€çº¢ç¢§çºï¼Œä¸ºæ˜å¤©åˆ¶å®š3ä¸ªå…·ä½“å¯è¡Œçš„å°ç›®æ ‡ï¼Œæ„Ÿå—æ°´æ™¶çš„ç¨³å®šèƒ½é‡å¸®åŠ©ä½ ä¸“æ³¨å½“ä¸‹' :
        'Hold red tourmaline and set 3 specific achievable goals for tomorrow, feel the crystal\'s stable energy help you focus on the present',
      timeCommitment: language === 'zh' ? '10åˆ†é’Ÿ' : '10 minutes',
      difficulty: 'easy',
      category: language === 'zh' ? 'ç›®æ ‡è§„åˆ’' : 'Goal Planning',
      icon: 'ğŸ“‹',
      crystalConnection: language === 'zh' ? 'çº¢ç¢§çºå¢å¼ºä¸“æ³¨åŠ›å’Œæ‰§è¡ŒåŠ›' : 'Red tourmaline enhances focus and execution'
    });
  }



  // æ€§æ ¼æ´å¯Ÿ
  if (mbtiType.includes('T')) {
    suggestions.insights.push({
      trait: language === 'zh' ? 'ç†æ€§å†³ç­–è€…' : 'Rational Decision Maker',
      description: language === 'zh' ? 
        'ä½ ä¹ æƒ¯ç”¨é€»è¾‘åˆ†æé—®é¢˜ï¼Œé‡è§†å®¢è§‚äº‹å®å’Œå› æœå…³ç³»' :
        'You habitually analyze problems logically, valuing objective facts and cause-effect relationships',
      strength: language === 'zh' ? 
        'åœ¨å¤æ‚æƒ…å†µä¸‹èƒ½ä¿æŒå†·é™ï¼Œåšå‡ºæ˜æ™ºå†³ç­–' :
        'Can stay calm in complex situations and make wise decisions',
      application: language === 'zh' ? 
        'é€‚åˆæ‹…ä»»åˆ†æå¸ˆã€é¡¹ç›®ç»ç†ç­‰éœ€è¦é€»è¾‘æ€ç»´çš„è§’è‰²' :
        'Suitable for roles requiring logical thinking like analyst, project manager'
    });
  } else {
    suggestions.insights.push({
      trait: language === 'zh' ? 'æƒ…æ„Ÿåè°ƒè€…' : 'Emotional Harmonizer',
      description: language === 'zh' ? 
        'ä½ é‡è§†äººé™…å’Œè°ï¼Œå–„äºç†è§£ä»–äººæ„Ÿå—å’Œéœ€æ±‚' :
        'You value interpersonal harmony and are good at understanding others\' feelings and needs',
      strength: language === 'zh' ? 
        'èƒ½å¤Ÿå»ºç«‹æ·±åº¦è¿æ¥ï¼Œåˆ›é€ æ¸©æš–åŒ…å®¹çš„ç¯å¢ƒ' :
        'Can build deep connections and create warm, inclusive environments',
      application: language === 'zh' ? 
        'é€‚åˆä»äº‹å’¨è¯¢ã€æ•™è‚²ã€äººåŠ›èµ„æºç­‰äººé™…å¯¼å‘çš„å·¥ä½œ' :
        'Suitable for people-oriented work like counseling, education, human resources'
    });
  }

  return suggestions;
};

// åŸºäºç§‘å­¦ç ”ç©¶çš„æ€§æ ¼åˆ†æ - ä»ImprovedPersonalityAnalysisç»„ä»¶ç§»æ¤
const generateScientificPersonalityAnalysis = (userProfile: UserProfileDataOutput, language: string) => {
  const analysis = {
    strengths: [] as Array<{title: string, description: string, evidence: string, applications: string[]}>,
    growthAreas: [] as Array<{title: string, description: string, strategies: string[], timeframe: string}>,
    cognitiveStyle: {} as {type: string, description: string, advantages: string[], considerations: string[]},
    recommendations: [] as Array<{category: string, title: string, description: string, priority: 'high' | 'medium' | 'low'}>
  };

  if (userProfile.mbtiLikeType) {
    const mbtiType = userProfile.mbtiLikeType;

    // åˆ†æè®¤çŸ¥é£æ ¼
    const isIntrovert = mbtiType.includes('I');
    const isIntuitive = mbtiType.includes('N');
    const isThinking = mbtiType.includes('T');
    const isJudging = mbtiType.includes('J');

    // è®¤çŸ¥é£æ ¼åˆ†æ
    analysis.cognitiveStyle = {
      type: language === 'zh' ?
        `${isIntrovert ? 'å†…å‘' : 'å¤–å‘'}-${isIntuitive ? 'ç›´è§‰' : 'å®æ„Ÿ'}-${isThinking ? 'æ€è€ƒ' : 'æƒ…æ„Ÿ'}-${isJudging ? 'åˆ¤æ–­' : 'æ„ŸçŸ¥'}å‹` :
        `${isIntrovert ? 'Introvert' : 'Extrovert'}-${isIntuitive ? 'Intuitive' : 'Sensing'}-${isThinking ? 'Thinking' : 'Feeling'}-${isJudging ? 'Judging' : 'Perceiving'}`,
      description: language === 'zh' ?
        'åŸºäºè®¤çŸ¥åŠŸèƒ½ç†è®ºï¼Œæ‚¨çš„ä¿¡æ¯å¤„ç†å’Œå†³ç­–é£æ ¼å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹' :
        'Based on cognitive function theory, your information processing and decision-making style has these characteristics',
      advantages: [],
      considerations: []
    };

    // å†…å‘/å¤–å‘ä¼˜åŠ¿
    if (isIntrovert) {
      analysis.strengths.push({
        title: language === 'zh' ? 'æ·±åº¦æ€è€ƒèƒ½åŠ›' : 'Deep Thinking Ability',
        description: language === 'zh' ?
          'å†…å‘è€…çš„å¤§è„‘å‰é¢å¶çš®è´¨æ›´æ´»è·ƒï¼Œæ“…é•¿æ·±åº¦åˆ†æå’Œç‹¬ç«‹æ€è€ƒ' :
          'Introverts have more active prefrontal cortex, excelling in deep analysis and independent thinking',
        evidence: language === 'zh' ? 'ç¥ç»ç§‘å­¦ç ”ç©¶ï¼ˆEysenck, 1967; DeYoung et al., 2010ï¼‰' : 'Neuroscience research (Eysenck, 1967; DeYoung et al., 2010)',
        applications: [
          language === 'zh' ? 'å¤æ‚é—®é¢˜è§£å†³' : 'Complex problem solving',
          language === 'zh' ? 'åˆ›æ„å†™ä½œå’Œè®¾è®¡' : 'Creative writing and design',
          language === 'zh' ? 'ç ”ç©¶å’Œåˆ†æå·¥ä½œ' : 'Research and analytical work'
        ]
      });

      analysis.cognitiveStyle.advantages.push(
        language === 'zh' ? 'åœ¨å®‰é™ç¯å¢ƒä¸­ä¸“æ³¨åŠ›æ›´å¼º' : 'Better focus in quiet environments',
        language === 'zh' ? 'å–„äºä¸€å¯¹ä¸€æ·±åº¦äº¤æµ' : 'Excellent at one-on-one deep conversations',
        language === 'zh' ? 'å†³ç­–å‰ä¼šå……åˆ†æ€è€ƒ' : 'Thorough consideration before decisions'
      );

      analysis.cognitiveStyle.considerations.push(
        language === 'zh' ? 'éœ€è¦ç‹¬å¤„æ—¶é—´æ¥æ¢å¤èƒ½é‡' : 'Need alone time to recharge energy',
        language === 'zh' ? 'åœ¨å¤§å‹ç¤¾äº¤åœºåˆå¯èƒ½æ„Ÿåˆ°ç–²æƒ«' : 'May feel drained in large social settings'
      );
    } else {
      analysis.strengths.push({
        title: language === 'zh' ? 'ç¤¾äº¤åè°ƒèƒ½åŠ›' : 'Social Coordination Ability',
        description: language === 'zh' ?
          'å¤–å‘è€…é€šè¿‡ç¤¾äº¤äº’åŠ¨è·å¾—èƒ½é‡ï¼Œæ“…é•¿å›¢é˜Ÿåä½œå’Œäººé™…æ²Ÿé€š' :
          'Extroverts gain energy from social interaction, excelling in teamwork and interpersonal communication',
        evidence: language === 'zh' ? 'ç¤¾ä¼šå¿ƒç†å­¦ç ”ç©¶ï¼ˆCosta & McCrae, 1992ï¼‰' : 'Social psychology research (Costa & McCrae, 1992)',
        applications: [
          language === 'zh' ? 'å›¢é˜Ÿé¢†å¯¼å’Œç®¡ç†' : 'Team leadership and management',
          language === 'zh' ? 'é”€å”®å’Œå®¢æˆ·æœåŠ¡' : 'Sales and customer service',
          language === 'zh' ? 'å…¬å…±æ¼”è®²å’ŒåŸ¹è®­' : 'Public speaking and training'
        ]
      });

      analysis.cognitiveStyle.advantages.push(
        language === 'zh' ? 'åœ¨å›¢é˜Ÿç¯å¢ƒä¸­è¡¨ç°å‡ºè‰²' : 'Excel in team environments',
        language === 'zh' ? 'å–„äºæ¿€åŠ±å’Œå½±å“ä»–äºº' : 'Good at motivating and influencing others',
        language === 'zh' ? 'èƒ½å¿«é€Ÿå»ºç«‹äººé™…å…³ç³»' : 'Can quickly build relationships'
      );
    }

    // ç›´è§‰/å®æ„Ÿä¼˜åŠ¿
    if (isIntuitive) {
      analysis.strengths.push({
        title: language === 'zh' ? 'åˆ›æ–°æ€ç»´èƒ½åŠ›' : 'Innovative Thinking Ability',
        description: language === 'zh' ?
          'ç›´è§‰å‹æ€ç»´è€…æ“…é•¿æ¨¡å¼è¯†åˆ«å’Œæ¦‚å¿µè¿æ¥ï¼Œå…·æœ‰å¼ºçƒˆçš„åˆ›æ–°å€¾å‘' :
          'Intuitive thinkers excel at pattern recognition and concept connection, with strong innovative tendencies',
        evidence: language === 'zh' ? 'åˆ›é€ åŠ›ç ”ç©¶ï¼ˆGuilford, 1967; Torrance, 1974ï¼‰' : 'Creativity research (Guilford, 1967; Torrance, 1974)',
        applications: [
          language === 'zh' ? 'äº§å“åˆ›æ–°å’Œè®¾è®¡' : 'Product innovation and design',
          language === 'zh' ? 'æˆ˜ç•¥è§„åˆ’' : 'Strategic planning',
          language === 'zh' ? 'è‰ºæœ¯å’Œåˆ›æ„å·¥ä½œ' : 'Artistic and creative work'
        ]
      });

      analysis.growthAreas.push({
        title: language === 'zh' ? 'ç»†èŠ‚æ‰§è¡ŒåŠ›' : 'Detail Execution',
        description: language === 'zh' ?
          'ç›´è§‰å‹æ€ç»´è€…å¯èƒ½åœ¨å…·ä½“æ‰§è¡Œå’Œç»†èŠ‚å…³æ³¨æ–¹é¢éœ€è¦åŠ å¼º' :
          'Intuitive thinkers may need to strengthen concrete execution and attention to detail',
        strategies: [
          language === 'zh' ? 'ä½¿ç”¨é¡¹ç›®ç®¡ç†å·¥å…·è·Ÿè¸ªè¿›åº¦' : 'Use project management tools to track progress',
          language === 'zh' ? 'è®¾ç½®å…·ä½“çš„é‡Œç¨‹ç¢‘å’Œæˆªæ­¢æ—¥æœŸ' : 'Set specific milestones and deadlines',
          language === 'zh' ? 'ä¸å®æ„Ÿå‹åŒäº‹åˆä½œäº’è¡¥' : 'Collaborate with sensing-type colleagues for balance'
        ],
        timeframe: language === 'zh' ? '3-6ä¸ªæœˆæŒç»­ç»ƒä¹ ' : '3-6 months of consistent practice'
      });
    } else {
      analysis.strengths.push({
        title: language === 'zh' ? 'å®åŠ¡æ‰§è¡Œèƒ½åŠ›' : 'Practical Execution Ability',
        description: language === 'zh' ?
          'å®æ„Ÿå‹æ€ç»´è€…æ³¨é‡å…·ä½“ç»†èŠ‚å’Œå®é™…åº”ç”¨ï¼Œæ‰§è¡ŒåŠ›å¼º' :
          'Sensing thinkers focus on concrete details and practical application, with strong execution skills',
        evidence: language === 'zh' ? 'è®¤çŸ¥å¿ƒç†å­¦ç ”ç©¶ï¼ˆJung, 1971; Myers, 1980ï¼‰' : 'Cognitive psychology research (Jung, 1971; Myers, 1980)',
        applications: [
          language === 'zh' ? 'é¡¹ç›®ç®¡ç†å’Œæ‰§è¡Œ' : 'Project management and execution',
          language === 'zh' ? 'è´¨é‡æ§åˆ¶å’Œæ”¹è¿›' : 'Quality control and improvement',
          language === 'zh' ? 'æ“ä½œå’ŒæŠ€æœ¯å·¥ä½œ' : 'Operations and technical work'
        ]
      });
    }

    // æ€è€ƒ/æƒ…æ„Ÿä¼˜åŠ¿
    if (isThinking) {
      analysis.strengths.push({
        title: language === 'zh' ? 'é€»è¾‘åˆ†æèƒ½åŠ›' : 'Logical Analysis Ability',
        description: language === 'zh' ?
          'æ€è€ƒå‹å†³ç­–è€…é‡è§†å®¢è§‚é€»è¾‘å’Œå› æœå…³ç³»ï¼Œå†³ç­–ç†æ€§' :
          'Thinking-type decision makers value objective logic and causality, making rational decisions',
        evidence: language === 'zh' ? 'å†³ç­–ç§‘å­¦ç ”ç©¶ï¼ˆKahneman, 2011ï¼‰' : 'Decision science research (Kahneman, 2011)',
        applications: [
          language === 'zh' ? 'æ•°æ®åˆ†æå’Œç ”ç©¶' : 'Data analysis and research',
          language === 'zh' ? 'ç³»ç»Ÿè®¾è®¡å’Œä¼˜åŒ–' : 'System design and optimization',
          language === 'zh' ? 'æ³•å¾‹å’Œå’¨è¯¢å·¥ä½œ' : 'Legal and consulting work'
        ]
      });
    } else {
      analysis.strengths.push({
        title: language === 'zh' ? 'äººé™…æ•æ„Ÿåº¦' : 'Interpersonal Sensitivity',
        description: language === 'zh' ?
          'æƒ…æ„Ÿå‹å†³ç­–è€…é‡è§†äººé™…å’Œè°å’Œä»–äººæ„Ÿå—ï¼Œå…·æœ‰é«˜æƒ…å•†' :
          'Feeling-type decision makers value interpersonal harmony and others\' feelings, with high emotional intelligence',
        evidence: language === 'zh' ? 'æƒ…å•†ç ”ç©¶ï¼ˆGoleman, 1995; Bar-On, 1997ï¼‰' : 'Emotional intelligence research (Goleman, 1995; Bar-On, 1997)',
        applications: [
          language === 'zh' ? 'äººåŠ›èµ„æºå’Œç»„ç»‡å‘å±•' : 'Human resources and organizational development',
          language === 'zh' ? 'å’¨è¯¢å’Œæ²»ç–—å·¥ä½œ' : 'Counseling and therapeutic work',
          language === 'zh' ? 'æ•™è‚²å’ŒåŸ¹è®­' : 'Education and training'
        ]
      });
    }
  }

  // é€šç”¨å»ºè®®
  analysis.recommendations = [
    {
      category: 'development',
      title: language === 'zh' ? 'ä¸ªäººå‘å±•è®¡åˆ’' : 'Personal Development Plan',
      description: language === 'zh' ?
        'åŸºäºæ‚¨çš„è®¤çŸ¥é£æ ¼åˆ¶å®šä¸ªæ€§åŒ–çš„æˆé•¿è®¡åˆ’' :
        'Create a personalized growth plan based on your cognitive style',
      priority: 'high' as const
    },
    {
      category: 'career',
      title: language === 'zh' ? 'èŒä¸šå‘å±•å»ºè®®' : 'Career Development Advice',
      description: language === 'zh' ?
        'é€‰æ‹©ä¸æ‚¨çš„ä¼˜åŠ¿åŒ¹é…çš„èŒä¸šæ–¹å‘å’Œå·¥ä½œç¯å¢ƒ' :
        'Choose career directions and work environments that match your strengths',
      priority: 'high' as const
    },
    {
      category: 'relationships',
      title: language === 'zh' ? 'äººé™…å…³ç³»ä¼˜åŒ–' : 'Relationship Optimization',
      description: language === 'zh' ?
        'äº†è§£ä¸åŒæ€§æ ¼ç±»å‹ï¼Œæ”¹å–„æ²Ÿé€šå’Œåä½œæ•ˆæœ' :
        'Understand different personality types to improve communication and collaboration',
      priority: 'medium' as const
    }
  ];

  return analysis;
};

const ImprovedPersonalizedSuggestions: React.FC<ImprovedPersonalizedSuggestionsProps> = ({
  userProfile,
  fiveDimensionalData,
  className = ""
}) => {
  const { language } = useLanguage();
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [show3DModel, setShow3DModel] = useState(true);
  const [showForecast, setShowForecast] = useState(false);
  const [showPersonalityAnalysis, setShowPersonalityAnalysis] = useState(false);

  // è®¡ç®—3Dèƒ½é‡æ¨¡å‹ - ä½¿ç”¨useMemoä¼˜åŒ–æ€§èƒ½
  const energyModel = useMemo(() => {
    try {
      return calculate3DEnergyModel(userProfile, fiveDimensionalData);
    } catch (error) {
      console.error('Error calculating 3D energy model:', error);
      return {
        physical: 70,
        mental: 70,
        spiritual: 70,
        balance: 70,
        trend: 'stable' as const,
        recommendations: ['è¯·ç¨åé‡è¯•']
      };
    }
  }, [userProfile, fiveDimensionalData]);

  // ç”Ÿæˆç§‘å­¦åŒ–å»ºè®® - ä½¿ç”¨useMemoä¼˜åŒ–æ€§èƒ½
  const scientificSuggestions = useMemo(() => {
    try {
      return generateScientificSuggestions(userProfile, energyModel, language);
    } catch (error) {
      console.error('Error generating scientific suggestions:', error);
      return [];
    }
  }, [userProfile, energyModel, language]);

  // ç”Ÿæˆæ¯æ—¥é¢„æµ‹ - ä½¿ç”¨useMemoä¼˜åŒ–æ€§èƒ½
  const dailyForecast = useMemo(() => {
    try {
      return generateDailyEnergyForecast(userProfile, language);
    } catch (error) {
      console.error('Error generating daily forecast:', error);
      return {
        date: new Date().toISOString().split('T')[0],
        energyPeak: '09:00-11:00',
        energyLow: '14:00-16:00',
        optimalActivities: ['ä¼‘æ¯'],
        avoidActivities: ['é«˜å¼ºåº¦å·¥ä½œ'],
        crystalRecommendation: 'ç™½æ°´æ™¶ - å‡€åŒ–èƒ½é‡',
        biorhythmPhase: 'physical' as const
      };
    }
  }, [userProfile, language]);

  const getEvidenceLevelColor = (level: string) => {
    switch (level) {
      case 'high': return 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300';
      case 'medium': return 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300';
      case 'low': return 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300';
      default: return 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300';
    }
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'easy': return 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300';
      case 'medium': return 'bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300';
      case 'hard': return 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
      default: return 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300';
    }
  };

  // å®‰å…¨æ£€æŸ¥
  if (!userProfile) {
    return (
      <Card className={`w-full ${className}`}>
        <CardContent className="flex items-center justify-center p-8">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">
              {language === 'zh' ? 'æ­£åœ¨åŠ è½½ä¸ªæ€§åŒ–å»ºè®®...' : 'Loading personalized suggestions...'}
            </p>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className={`w-full ${className}`}>
      <CardHeader className="text-center pb-4">
        <CardTitle className="flex items-center justify-center gap-3 text-xl">
          <Atom className="h-6 w-6 text-primary animate-pulse" />
          <span className="bg-gradient-to-r from-blue-600 via-purple-600 to-cyan-600 bg-clip-text text-transparent font-bold">
            {language === 'zh' ? 'ğŸ”¬ ç§‘å­¦èƒ½é‡ä¼˜åŒ–å»ºè®®' : 'ğŸ”¬ Scientific Energy Optimization'}
          </span>
        </CardTitle>
        <div className="flex items-center justify-center gap-2 mt-2">
          <Badge className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white">
            {language === 'zh' ? 'åŸºäºç§‘å­¦ç ”ç©¶' : 'Evidence-Based'}
          </Badge>
          <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
            {userProfile.mbtiLikeType || (language === 'zh' ? 'ä¸ªæ€§åŒ–ç®—æ³•' : 'Personalized Algorithm')}
          </Badge>
          <Badge variant="outline" className="border-cyan-300">
            {language === 'zh' ? '3Dèƒ½é‡æ¨¡å‹' : '3D Energy Model'}
          </Badge>
        </div>
      </CardHeader>

      <CardContent className="space-y-6">
        {/* 3Dèƒ½é‡æ¨¡å‹æ˜¾ç¤º */}
        <Card className="border-l-4 border-l-cyan-500 bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-950/30 dark:to-blue-950/30">
          <Collapsible open={show3DModel} onOpenChange={setShow3DModel}>
            <CollapsibleTrigger asChild>
              <CardHeader className="pb-3 cursor-pointer hover:bg-accent/5 transition-colors">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <Hexagon className="h-5 w-5 text-cyan-600 animate-spin" style={{animationDuration: '3s'}} />
                    {language === 'zh' ? 'ğŸ”® æ¯æ—¥3Dèƒ½é‡æ¨¡å‹' : 'ğŸ”® Daily 3D Energy Model'}
                  </CardTitle>
                  {show3DModel ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
                </div>
                <p className="text-sm text-muted-foreground">
                  {language === 'zh' ? 'åŸºäºç”Ÿç‰©èŠ‚å¾‹å’Œå¿ƒç†å­¦ç†è®ºçš„å®æ—¶èƒ½é‡åˆ†æ' : 'Real-time energy analysis based on biorhythm and psychological theories'}
                </p>
              </CardHeader>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <CardContent className="space-y-4">
                {/* ä½¿ç”¨æ–°çš„å›¾è¡¨ç»„ä»¶ */}
                <EnergyCharts energyModel={energyModel} language={language} />

                {/* 3Dèƒ½é‡æŒ‡æ ‡å¡ç‰‡ */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Flame className="h-5 w-5 text-red-500" />
                      <span className="font-medium text-red-700 dark:text-red-300">
                        {language === 'zh' ? 'èº«ä½“èƒ½é‡' : 'Physical Energy'}
                      </span>
                    </div>
                    <div className="space-y-2">
                      <Progress value={Math.min(100, Math.max(0, energyModel.physical || 0))} className="h-2" />
                      <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">{(energyModel.physical || 0).toFixed(0)}%</span>
                        <span className="text-red-600 font-medium">
                          {(energyModel.physical || 0) >= 80 ? (language === 'zh' ? 'ä¼˜ç§€' : 'Excellent') :
                           (energyModel.physical || 0) >= 60 ? (language === 'zh' ? 'è‰¯å¥½' : 'Good') :
                           language === 'zh' ? 'éœ€æå‡' : 'Needs Improvement'}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Brain className="h-5 w-5 text-purple-500" />
                      <span className="font-medium text-purple-700 dark:text-purple-300">
                        {language === 'zh' ? 'å¿ƒç†èƒ½é‡' : 'Mental Energy'}
                      </span>
                    </div>
                    <div className="space-y-2">
                      <Progress value={Math.min(100, Math.max(0, energyModel.mental || 0))} className="h-2" />
                      <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">{(energyModel.mental || 0).toFixed(0)}%</span>
                        <span className="text-purple-600 font-medium">
                          {(energyModel.mental || 0) >= 80 ? (language === 'zh' ? 'ä¼˜ç§€' : 'Excellent') :
                           (energyModel.mental || 0) >= 60 ? (language === 'zh' ? 'è‰¯å¥½' : 'Good') :
                           language === 'zh' ? 'éœ€æå‡' : 'Needs Improvement'}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Star className="h-5 w-5 text-blue-500" />
                      <span className="font-medium text-blue-700 dark:text-blue-300">
                        {language === 'zh' ? 'ç²¾ç¥èƒ½é‡' : 'Spiritual Energy'}
                      </span>
                    </div>
                    <div className="space-y-2">
                      <Progress value={Math.min(100, Math.max(0, energyModel.spiritual || 0))} className="h-2" />
                      <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">{(energyModel.spiritual || 0).toFixed(0)}%</span>
                        <span className="text-blue-600 font-medium">
                          {(energyModel.spiritual || 0) >= 80 ? (language === 'zh' ? 'ä¼˜ç§€' : 'Excellent') :
                           (energyModel.spiritual || 0) >= 60 ? (language === 'zh' ? 'è‰¯å¥½' : 'Good') :
                           language === 'zh' ? 'éœ€æå‡' : 'Needs Improvement'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* å¹³è¡¡æŒ‡æ•°å’Œè¶‹åŠ¿ */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 rounded-lg border border-green-200 dark:border-green-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Gauge className="h-5 w-5 text-green-500" />
                      <span className="font-medium text-green-700 dark:text-green-300">
                        {language === 'zh' ? 'å¹³è¡¡æŒ‡æ•°' : 'Balance Index'}
                      </span>
                    </div>
                    <div className="text-2xl font-bold text-green-600">{(energyModel.balance || 0).toFixed(1)}%</div>
                    <p className="text-sm text-green-600 mt-1">
                      {(energyModel.balance || 0) >= 80 ? (language === 'zh' ? 'é«˜åº¦å¹³è¡¡' : 'Highly Balanced') :
                       (energyModel.balance || 0) >= 60 ? (language === 'zh' ? 'åŸºæœ¬å¹³è¡¡' : 'Moderately Balanced') :
                       language === 'zh' ? 'éœ€è¦è°ƒæ•´' : 'Needs Adjustment'}
                    </p>
                  </div>

                  <div className="p-4 bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-orange-950/30 dark:to-yellow-950/30 rounded-lg border border-orange-200 dark:border-orange-800">
                    <div className="flex items-center gap-2 mb-2">
                      {energyModel.trend === 'rising' ? <TrendingUp className="h-5 w-5 text-green-500" /> :
                       energyModel.trend === 'declining' ? <TrendingDown className="h-5 w-5 text-red-500" /> :
                       <Activity className="h-5 w-5 text-orange-500" />}
                      <span className="font-medium text-orange-700 dark:text-orange-300">
                        {language === 'zh' ? 'èƒ½é‡è¶‹åŠ¿' : 'Energy Trend'}
                      </span>
                    </div>
                    <div className="text-lg font-semibold">
                      {energyModel.trend === 'rising' ? (language === 'zh' ? 'ğŸ“ˆ ä¸Šå‡æœŸ' : 'ğŸ“ˆ Rising') :
                       energyModel.trend === 'declining' ? (language === 'zh' ? 'ğŸ“‰ ä¸‹é™æœŸ' : 'ğŸ“‰ Declining') :
                       language === 'zh' ? 'ğŸ“Š ç¨³å®šæœŸ' : 'ğŸ“Š Stable'}
                    </div>
                    <p className="text-sm text-orange-600 mt-1">
                      {energyModel.trend === 'rising' ? (language === 'zh' ? 'é€‚åˆæŒ‘æˆ˜æ–°ä»»åŠ¡' : 'Good for new challenges') :
                       energyModel.trend === 'declining' ? (language === 'zh' ? 'å»ºè®®ä¼‘æ¯æ¢å¤' : 'Recommended to rest') :
                       language === 'zh' ? 'ç»´æŒå½“å‰èŠ‚å¥' : 'Maintain current pace'}
                    </p>
                  </div>
                </div>

                {/* èƒ½é‡ä¼˜åŒ–å»ºè®® */}
                <div className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 rounded-lg border border-indigo-200 dark:border-indigo-800">
                  <h4 className="font-medium text-indigo-700 dark:text-indigo-300 mb-2 flex items-center gap-2">
                    <Lightbulb className="h-4 w-4" />
                    {language === 'zh' ? 'æ™ºèƒ½ä¼˜åŒ–å»ºè®®' : 'Smart Optimization Tips'}
                  </h4>
                  <div className="space-y-1">
                    {(energyModel.recommendations || []).map((rec, index) => (
                      <div key={index} className="text-sm text-indigo-600 dark:text-indigo-400 flex items-center gap-2">
                        <CheckCircle className="h-3 w-3 flex-shrink-0" />
                        {rec}
                      </div>
                    ))}
                  </div>
                </div>
              </CardContent>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* ç§‘å­¦åŒ–å»ºè®®åˆ—è¡¨ */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card className="border-l-4 border-l-blue-500">
            <CardHeader className="pb-3">
              <CardTitle className="flex items-center gap-2 text-lg">
                <Target className="h-5 w-5 text-blue-600" />
                {language === 'zh' ? 'ğŸ¯ å¾ªè¯å®è·µå»ºè®®' : 'ğŸ¯ Evidence-Based Practices'}
              </CardTitle>
              <p className="text-sm text-muted-foreground">
                {language === 'zh' ? 'åŸºäºç§‘å­¦ç ”ç©¶çš„ä¸ªæ€§åŒ–èƒ½é‡æå‡æ–¹æ¡ˆ' : 'Personalized energy enhancement based on scientific research'}
              </p>
            </CardHeader>
            <CardContent className="space-y-4">
              {(scientificSuggestions || []).slice(0, 3).map((suggestion, index) => (
                <div key={suggestion.id} className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-lg border border-blue-200 dark:border-blue-800 hover:shadow-md transition-shadow">
                  <div className="flex items-start gap-3">
                    <div className="text-2xl">{suggestion.icon}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h4 className="font-semibold text-foreground">{suggestion.title}</h4>
                        <Badge className={getEvidenceLevelColor(suggestion.evidenceLevel)}>
                          {suggestion.evidenceLevel === 'high' ? (language === 'zh' ? 'é«˜è¯æ®' : 'High Evidence') :
                           suggestion.evidenceLevel === 'medium' ? (language === 'zh' ? 'ä¸­è¯æ®' : 'Medium Evidence') :
                           language === 'zh' ? 'ä½è¯æ®' : 'Low Evidence'}
                        </Badge>
                      </div>

                      <p className="text-sm text-muted-foreground mb-3">{suggestion.description}</p>

                      <div className="space-y-2">
                        <div className="flex items-center gap-2 text-xs">
                          <Clock className="h-3 w-3 text-blue-500" />
                          <span className="text-blue-600">{suggestion.timeCommitment}</span>
                          <Badge className={getDifficultyColor(suggestion.difficulty)} variant="outline">
                            {suggestion.difficulty === 'easy' ? (language === 'zh' ? 'ç®€å•' : 'Easy') :
                             suggestion.difficulty === 'medium' ? (language === 'zh' ? 'ä¸­ç­‰' : 'Medium') :
                             language === 'zh' ? 'å›°éš¾' : 'Hard'}
                          </Badge>
                        </div>

                        {suggestion.crystalConnection && (
                          <div className="flex items-center gap-2 text-xs text-purple-600">
                            <Gem className="h-3 w-3" />
                            <span>{suggestion.crystalConnection}</span>
                          </div>
                        )}

                        <div className="bg-white dark:bg-gray-800 p-2 rounded border-l-2 border-l-green-400">
                          <p className="text-xs text-green-700 dark:text-green-300 font-medium mb-1">
                            {language === 'zh' ? 'ç§‘å­¦ä¾æ®:' : 'Scientific Basis:'}
                          </p>
                          <p className="text-xs text-green-600 dark:text-green-400">{suggestion.scientificBasis}</p>
                        </div>

                        {suggestion.researchCitation && (
                          <div className="text-xs text-gray-500 italic">
                            ğŸ“š {suggestion.researchCitation}
                          </div>
                        )}

                        <div className="flex items-center gap-4 text-xs">
                          <div className="flex items-center gap-1">
                            <Target className="h-3 w-3 text-orange-500" />
                            <span className="text-orange-600">{suggestion.expectedOutcome}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* æ¯æ—¥èƒ½é‡é¢„æµ‹ */}
          <Card className="border-l-4 border-l-purple-500">
            <Collapsible open={showForecast} onOpenChange={setShowForecast}>
              <CollapsibleTrigger asChild>
                <CardHeader className="pb-3 cursor-pointer hover:bg-accent/5 transition-colors">
                  <div className="flex items-center justify-between">
                    <CardTitle className="flex items-center gap-2 text-lg">
                      <Calendar className="h-5 w-5 text-purple-600" />
                      {language === 'zh' ? 'ğŸ“… ä»Šæ—¥èƒ½é‡é¢„æµ‹' : 'ğŸ“… Daily Energy Forecast'}
                    </CardTitle>
                    {showForecast ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
                  </div>
                  <p className="text-sm text-muted-foreground">
                    {language === 'zh' ? 'åŸºäºç”Ÿç‰©èŠ‚å¾‹å’Œä¸ªäººç‰¹è´¨çš„æ™ºèƒ½é¢„æµ‹' : 'Smart predictions based on biorhythm and personal traits'}
                  </p>
                </CardHeader>
              </CollapsibleTrigger>
              <CollapsibleContent>
                <CardContent className="space-y-4">
                  {/* èƒ½é‡æ—¶é—´è½´ */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="p-3 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 rounded-lg border border-green-200 dark:border-green-800">
                      <div className="flex items-center gap-2 mb-2">
                        <Sun className="h-4 w-4 text-green-500" />
                        <span className="font-medium text-green-700 dark:text-green-300">
                          {language === 'zh' ? 'èƒ½é‡é«˜å³°æœŸ' : 'Energy Peak'}
                        </span>
                      </div>
                      <div className="text-lg font-bold text-green-600">{dailyForecast?.energyPeak || '09:00-11:00'}</div>
                      <p className="text-xs text-green-600 mt-1">
                        {language === 'zh' ? 'æœ€ä½³å·¥ä½œå’Œå­¦ä¹ æ—¶é—´' : 'Optimal time for work and study'}
                      </p>
                    </div>

                    <div className="p-3 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-950/30 dark:to-red-950/30 rounded-lg border border-orange-200 dark:border-orange-800">
                      <div className="flex items-center gap-2 mb-2">
                        <Moon className="h-4 w-4 text-orange-500" />
                        <span className="font-medium text-orange-700 dark:text-orange-300">
                          {language === 'zh' ? 'èƒ½é‡ä½è°·æœŸ' : 'Energy Low'}
                        </span>
                      </div>
                      <div className="text-lg font-bold text-orange-600">{dailyForecast?.energyLow || '14:00-16:00'}</div>
                      <p className="text-xs text-orange-600 mt-1">
                        {language === 'zh' ? 'å»ºè®®ä¼‘æ¯æˆ–è½»æ¾æ´»åŠ¨' : 'Recommended for rest or light activities'}
                      </p>
                    </div>
                  </div>

                  {/* ç”Ÿç‰©èŠ‚å¾‹ç›¸ä½ */}
                  <div className="p-4 bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-950/30 dark:to-blue-950/30 rounded-lg border border-indigo-200 dark:border-indigo-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Waves className="h-4 w-4 text-indigo-500" />
                      <span className="font-medium text-indigo-700 dark:text-indigo-300">
                        {language === 'zh' ? 'ç”Ÿç‰©èŠ‚å¾‹ç›¸ä½' : 'Biorhythm Phase'}
                      </span>
                    </div>
                    <div className="text-lg font-semibold text-indigo-600">
                      {(dailyForecast?.biorhythmPhase || 'physical') === 'physical' ? (language === 'zh' ? 'ğŸƒâ€â™‚ï¸ èº«ä½“å‘¨æœŸ' : 'ğŸƒâ€â™‚ï¸ Physical Cycle') :
                       (dailyForecast?.biorhythmPhase || 'physical') === 'emotional' ? (language === 'zh' ? 'â¤ï¸ æƒ…æ„Ÿå‘¨æœŸ' : 'â¤ï¸ Emotional Cycle') :
                       language === 'zh' ? 'ğŸ§  æ™ºåŠ›å‘¨æœŸ' : 'ğŸ§  Intellectual Cycle'}
                    </div>
                    <p className="text-sm text-indigo-600 mt-1">
                      {(dailyForecast?.biorhythmPhase || 'physical') === 'physical' ? (language === 'zh' ? 'é€‚åˆä½“åŠ›æ´»åŠ¨å’Œè¿åŠ¨' : 'Good for physical activities and exercise') :
                       (dailyForecast?.biorhythmPhase || 'physical') === 'emotional' ? (language === 'zh' ? 'é€‚åˆç¤¾äº¤å’Œæƒ…æ„Ÿè¡¨è¾¾' : 'Good for socializing and emotional expression') :
                       language === 'zh' ? 'é€‚åˆå­¦ä¹ å’Œæ€è€ƒ' : 'Good for learning and thinking'}
                    </p>
                  </div>

                  {/* æ¨èæ´»åŠ¨ */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <h4 className="font-medium text-green-700 dark:text-green-300 flex items-center gap-2">
                        <CheckCircle className="h-4 w-4" />
                        {language === 'zh' ? 'æ¨èæ´»åŠ¨' : 'Recommended Activities'}
                      </h4>
                      <div className="space-y-1">
                        {(dailyForecast?.optimalActivities || []).map((activity, index) => (
                          <div key={index} className="text-sm text-green-600 dark:text-green-400 flex items-center gap-2">
                            <Star className="h-3 w-3 flex-shrink-0" />
                            {activity}
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="space-y-2">
                      <h4 className="font-medium text-red-700 dark:text-red-300 flex items-center gap-2">
                        <AlertCircle className="h-4 w-4" />
                        {language === 'zh' ? 'é¿å…æ´»åŠ¨' : 'Avoid Activities'}
                      </h4>
                      <div className="space-y-1">
                        {(dailyForecast?.avoidActivities || []).map((activity, index) => (
                          <div key={index} className="text-sm text-red-600 dark:text-red-400 flex items-center gap-2">
                            <AlertCircle className="h-3 w-3 flex-shrink-0" />
                            {activity}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* ä»Šæ—¥æ°´æ™¶æ¨è */}
                  <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 rounded-lg border border-purple-200 dark:border-purple-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Gem className="h-4 w-4 text-purple-500" />
                      <span className="font-medium text-purple-700 dark:text-purple-300">
                        {language === 'zh' ? 'ä»Šæ—¥æ°´æ™¶æ¨è' : 'Today\'s Crystal Recommendation'}
                      </span>
                    </div>
                    <div className="text-lg font-semibold text-purple-600">{dailyForecast?.crystalRecommendation || 'ç™½æ°´æ™¶ - å‡€åŒ–èƒ½é‡'}</div>
                  </div>
                </CardContent>
              </CollapsibleContent>
            </Collapsible>
          </Card>
        </div>

        {/* é«˜çº§ç§‘å­¦åˆ†æ */}
        <Card className="border-l-4 border-l-indigo-500">
          <Collapsible open={showAdvanced} onOpenChange={setShowAdvanced}>
            <CollapsibleTrigger asChild>
              <CardHeader className="pb-3 cursor-pointer hover:bg-accent/5 transition-colors">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <BarChart3 className="h-5 w-5 text-indigo-600" />
                    {language === 'zh' ? 'ğŸ”¬ é«˜çº§ç§‘å­¦åˆ†æ' : 'ğŸ”¬ Advanced Scientific Analysis'}
                  </CardTitle>
                  {showAdvanced ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
                </div>
                <p className="text-sm text-muted-foreground">
                  {language === 'zh' ? 'æ·±åº¦å¿ƒç†å­¦å’Œç¥ç»ç§‘å­¦åˆ†ææŠ¥å‘Š' : 'In-depth psychological and neuroscientific analysis report'}
                </p>
              </CardHeader>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <CardContent className="space-y-4">
                {/* å‰©ä½™ç§‘å­¦å»ºè®® */}
                {(scientificSuggestions || []).slice(3).map((suggestion, index) => (
                  <div key={suggestion.id} className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 rounded-lg border border-indigo-200 dark:border-indigo-800">
                    <div className="flex items-start gap-3">
                      <div className="text-2xl">{suggestion.icon}</div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <h4 className="font-semibold text-foreground">{suggestion.title}</h4>
                          <Badge className={getEvidenceLevelColor(suggestion.evidenceLevel)}>
                            {suggestion.evidenceLevel === 'high' ? (language === 'zh' ? 'é«˜è¯æ®' : 'High Evidence') :
                             suggestion.evidenceLevel === 'medium' ? (language === 'zh' ? 'ä¸­è¯æ®' : 'Medium Evidence') :
                             language === 'zh' ? 'ä½è¯æ®' : 'Low Evidence'}
                          </Badge>
                        </div>

                        <p className="text-sm text-muted-foreground mb-3">{suggestion.description}</p>

                        <div className="space-y-2">
                          <div className="bg-white dark:bg-gray-800 p-3 rounded border-l-2 border-l-blue-400">
                            <p className="text-xs text-blue-700 dark:text-blue-300 font-medium mb-1">
                              {language === 'zh' ? 'ç§‘å­¦æœºåˆ¶:' : 'Scientific Mechanism:'}
                            </p>
                            <p className="text-xs text-blue-600 dark:text-blue-400">{suggestion.scientificBasis}</p>
                          </div>

                          <div className="bg-white dark:bg-gray-800 p-3 rounded border-l-2 border-l-green-400">
                            <p className="text-xs text-green-700 dark:text-green-300 font-medium mb-1">
                              {language === 'zh' ? 'é¢„æœŸæ•ˆæœ:' : 'Expected Outcome:'}
                            </p>
                            <p className="text-xs text-green-600 dark:text-green-400">{suggestion.expectedOutcome}</p>
                          </div>

                          <div className="bg-white dark:bg-gray-800 p-3 rounded border-l-2 border-l-orange-400">
                            <p className="text-xs text-orange-700 dark:text-orange-300 font-medium mb-1">
                              {language === 'zh' ? 'æµ‹é‡æ–¹æ³•:' : 'Measurement Method:'}
                            </p>
                            <p className="text-xs text-orange-600 dark:text-orange-400">{suggestion.measurementMethod}</p>
                          </div>

                          {suggestion.researchCitation && (
                            <div className="text-xs text-gray-500 italic bg-gray-50 dark:bg-gray-800 p-2 rounded">
                              ğŸ“š {language === 'zh' ? 'ç ”ç©¶å¼•ç”¨: ' : 'Research Citation: '}{suggestion.researchCitation}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}

                {/* ç§‘å­¦æ–¹æ³•è®ºè¯´æ˜ */}
                <div className="p-4 bg-gradient-to-r from-gray-50 to-slate-50 dark:from-gray-950/30 dark:to-slate-950/30 rounded-lg border border-gray-200 dark:border-gray-800">
                  <h4 className="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                    <Shield className="h-4 w-4" />
                    {language === 'zh' ? 'ç§‘å­¦æ–¹æ³•è®º' : 'Scientific Methodology'}
                  </h4>
                  <div className="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                    <p>
                      {language === 'zh' ?
                        'æœ¬åˆ†æåŸºäºå¾ªè¯å¿ƒç†å­¦åŸç†ï¼Œç»“åˆç”Ÿç‰©èŠ‚å¾‹ç†è®ºã€è®¤çŸ¥è´Ÿè·ç†è®ºã€é©¬æ–¯æ´›éœ€æ±‚å±‚æ¬¡ç†è®ºç­‰æƒå¨ç§‘å­¦æ¡†æ¶ã€‚' :
                        'This analysis is based on evidence-based psychology principles, combined with authoritative scientific frameworks such as biorhythm theory, cognitive load theory, and Maslow\'s hierarchy of needs.'}
                    </p>
                    <p>
                      {language === 'zh' ?
                        'æ‰€æœ‰å»ºè®®éƒ½ç»è¿‡åŒè¡Œè¯„è®®çš„ç ”ç©¶éªŒè¯ï¼Œå¹¶æ ¹æ®æ‚¨çš„ä¸ªäººç‰¹è´¨è¿›è¡Œä¸ªæ€§åŒ–è°ƒæ•´ã€‚' :
                        'All recommendations are validated by peer-reviewed research and personalized according to your individual traits.'}
                    </p>
                  </div>
                </div>
              </CardContent>
            </CollapsibleContent>
          </Collapsible>
        </Card>
      </CardContent>
    </Card>
  );
};

export default ImprovedPersonalizedSuggestions;
